{#include main}
  {#title}Histórico de Lances - {leilao.titulo}{/title}

  {#content}
  <div class="container mt-4">
    <h1>Histórico de Lances</h1>
    <h2 class="mb-3">{leilao.titulo}</h2>
    
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0">Informações do Leilão</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Criado por:</strong> {leilao.criador.nome}</p>
            <p><strong>Início:</strong> {leilao.dataInicio.format('dd/MM/yyyy HH:mm')}</p>
            <p><strong>Término:</strong> {leilao.dataFim.format('dd/MM/yyyy HH:mm')}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Status:</strong> <span class="badge {#switch leilao.status}{#case ABERTO}bg-success{#case ENCERRADO}bg-danger{#case CONCLUIDO}bg-info{#case CANCELADO}bg-warning{/switch}">{leilao.status}</span></p>
            <p><strong>Tipo:</strong> {leilao.tipoLeilao}</p>
            <p><strong>Quantidade:</strong> {leilao.quantidade} {leilao.unidadeMedida}</p>
          </div>
        </div>
      </div>
    </div>

    {#if leilao.lances.isEmpty()}
      <div class="alert alert-info">
        Nenhum lance foi registrado para este leilão ainda.
      </div>
    {#else}
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Data/Hora</th>
              <th>Fornecedor</th>
              <th>Valor</th>
              <th>Prazo Entrega</th>
              <th>Prazo Pagamento</th>
              <th>Condições Entrega</th>
            </tr>
          </thead>
          <tbody>
            {#for lance in leilao.lances.sort((a, b) -> a.valor.compareTo(b.valor))}
              <tr {#if lance == leilao.lances.stream().min((a, b) -> a.valor.compareTo(b.valor)).orElse(null)}class="table-success"{/if}>
                <td>{lance.dataCriacao.format('dd/MM/yyyy HH:mm:ss')}</td>
                <td>{lance.fornecedor.nome}</td>
                <td class="text-end">R$ {lance.valor.toString().replace('.', ',')}</td>
                <td>{#if lance.prazoEntrega}{lance.prazoEntrega} dias{#else}N/A{/if}</td>
                <td>{#if lance.prazoPagamento}{lance.prazoPagamento} dias{#else}N/A{/if}</td>
                <td>{#if lance.condicoesEntrega}{lance.condicoesEntrega}{#else}Não especificado{/if}</td>
              </tr>
            {/for}
          </tbody>
        </table>
      </div>

      {#if leilao.status == 'CONCLUIDO' && usuarioLogado.equals(leilao.criador)}
        {#with leilao.lances.stream().min((a, b) -> a.valor.compareTo(b.valor)).orElse(null) as menorLance}
          {#if menorLance != null}
            <div class="card mt-4 border-success">
              <div class="card-header bg-success text-white">
                <h3 class="mb-0">Fornecedor Vencedor</h3>
              </div>
              <div class="card-body">
                <h4>{menorLance.fornecedor.nome}</h4>
                <p><strong>Valor:</strong> R$ {menorLance.valor.toString().replace('.', ',')}</p>
                <p><strong>Prazo de Entrega:</strong> {#if menorLance.prazoEntrega}{menorLance.prazoEntrega} dias{#else}N/A{/if}</p>
                <p><strong>Prazo de Pagamento:</strong> {#if menorLance.prazoPagamento}{menorLance.prazoPagamento} dias{#else}N/A{/if}</p>
                <p><strong>Condições de Entrega:</strong> {#if menorLance.condicoesEntrega}{menorLance.condicoesEntrega}{#else}Não especificado{/if}</p>
                
                <a href="/avaliacoes/avaliar/{leilao.id}/{menorLance.fornecedor.id}" class="btn btn-primary">
                  Avaliar Fornecedor
                </a>
              </div>
            </div>
          {/if}
        {/with}
      {/if}

      {#if leilao.status == 'CONCLUIDO' && usuarioLogado.tipoUsuario == 'FORNECEDOR'}
        {#with leilao.lances.stream().min((a, b) -> a.valor.compareTo(b.valor)).orElse(null) as menorLance}
          {#if menorLance != null && menorLance.fornecedor.equals(usuarioLogado)}
            <div class="card mt-4 border-success">
              <div class="card-header bg-success text-white">
                <h3 class="mb-0">Parabéns! Seu lance foi vencedor</h3>
              </div>
              <div class="card-body">
                <p>Você ofereceu o melhor lance neste leilão.</p>
                <a href="/avaliacoes/avaliar/{leilao.id}/{leilao.criador.id}" class="btn btn-primary">
                  Avaliar Comprador
                </a>
              </div>
            </div>
          {/if}
        {/with}
      {/if}
    {/if}

    <div class="mt-4">
      <a href="/leiloes/{leilao.id}" class="btn btn-secondary">Voltar ao Leilão</a>
    </div>
  </div>
  {/content}
{/include}
